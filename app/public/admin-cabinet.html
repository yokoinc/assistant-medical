<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramètres - Administration</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/styles.css?v=parameters-cards-fixed" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div>
                        <h1 id="adminTitle">Administration</h1>
                        <p id="doctorSpecialty">Configuration Cabinet</p>
                    </div>
                </div>
                <nav class="nav">
                    <a href="/admin/dashboard" class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        Dashboard
                    </a>
                    <a href="/admin/patients" class="nav-link">
                        <i class="fas fa-users"></i>
                        Patients
                    </a>
                    <a href="/admin/schedule" class="nav-link">
                        <i class="fas fa-calendar"></i>
                        Planning
                    </a>
                    <a href="/admin/chat" class="nav-link">
                        <i class="fas fa-robot"></i>
                        Chat IA
                    </a>
                    <a href="/admin/cabinet" class="nav-link active">
                        <i class="fas fa-building"></i>
                        Cabinet
                    </a>
                    <a href="/admin/emergency" class="nav-link">
                        <i class="fas fa-phone-alt"></i>
                        Urgences
                    </a>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Déconnexion
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <section class="section" style="padding-top: var(--spacing-12);">
            <div class="container">
                <!-- Alerts -->
                <div id="successAlert" class="alert success" style="display: none;">
                    <i class="fas fa-check-circle"></i>
                    <span id="successMessage">Paramètres sauvegardés avec succès</span>
                </div>

                <div id="errorAlert" class="alert error" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="errorMessage">Erreur lors de la sauvegarde</span>
                </div>
            <!-- Informations Générales -->
            <div class="card">
                <div class="card-header">
                    <h2 class="section-title">
                        <i class="fas fa-user-md"></i>
                        Informations Générales
                    </h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label" for="cabinet_nom_docteur">Nom du Médecin</label>
                        <input type="text" id="cabinet_nom_docteur" class="form-control" placeholder="Dr Nom Prénom">
                        <div class="form-description">Nom complet qui apparaîtra sur toutes les pages</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_specialite">Spécialité</label>
                        <input type="text" id="cabinet_specialite" class="form-control" placeholder="Médecin Généraliste">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_ville">Ville</label>
                        <div >
                            <input type="text" id="cabinet_ville" class="form-control" placeholder="Votre Ville" autocomplete="off">
                            <div id="ville-suggestions" class="suggestions-dropdown" ></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="assistant_nom">Nom de l'Assistant IA</label>
                        <input type="text" id="assistant_nom" class="form-control" placeholder="Assistant Médical">
                    </div>

                    <button class="btn btn-primary" id="saveGeneralBtn">
                        <i class="fas fa-save"></i>
                        Sauvegarder
                    </button>
                </div>
            </div>

            <!-- Coordonnées -->
            <div class="card" style="margin-top: var(--spacing-6);">
                <div class="card-header">
                    <h2 class="section-title">
                        <i class="fas fa-address-book"></i>
                        Coordonnées
                    </h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label" for="cabinet_telephone">Téléphone</label>
                        <input type="tel" id="cabinet_telephone" class="form-control" placeholder="+33 X XX XX XX XX" pattern="\+33 [1-9] \d{2} \d{2} \d{2} \d{2}" maxlength="17">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_email">Email (optionnel)</label>
                        <input type="email" id="cabinet_email" class="form-control" placeholder="contact@votre-cabinet.fr">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_adresse">Adresse du cabinet</label>
                        <div >
                            <textarea id="cabinet_adresse" class="form-textarea" placeholder="Adresse complète du cabinet" autocomplete="off"></textarea>
                            <div id="adresse-suggestions" class="suggestions-dropdown" ></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_site_web">Site de prise de rendez-vous (optionnel)</label>
                        <input type="url" id="cabinet_site_web" class="form-control" placeholder="https://votre-site-rdv.fr">
                    </div>

                    <button class="btn btn-primary" id="saveContactBtn">
                        <i class="fas fa-save"></i>
                        Sauvegarder
                    </button>
                </div>
            </div>


            <!-- Informations Pratiques -->
            <div class="card" style="margin-top: var(--spacing-6);">
                <div class="card-header">
                    <h2 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Informations Pratiques
                    </h2>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label class="form-label" for="cabinet_rdv_mode">Mode de prise de rendez-vous</label>
                        <input type="text" id="cabinet_rdv_mode" class="form-control" placeholder="Sur rendez-vous uniquement">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_parking">Parking</label>
                        <input type="text" id="cabinet_parking" class="form-control" placeholder="Parking gratuit disponible">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_acces">Accessibilité</label>
                        <input type="text" id="cabinet_acces" class="form-control" placeholder="Accessible PMR">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_infos_pratiques">Informations pratiques importantes</label>
                        <textarea id="cabinet_infos_pratiques" class="form-textarea" rows="4" placeholder="Consultations sur rendez-vous uniquement&#10;En cas d'urgence, contactez le 15 (SAMU)&#10;Veuillez arriver 10 minutes avant votre rendez-vous"></textarea>
                        <small class="form-help">Ces informations seront affichées sur la page d'accueil</small>
                    </div>

                    <button class="btn btn-primary" id="savePracticalBtn">
                        <i class="fas fa-save"></i>
                        Sauvegarder
                    </button>
                </div>
            </div>

            </div>
        </section>
    </main>

    <script>
        // Variables globales
        let currentSettings = {};

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadAllSettings();
            setupEventListeners();
        });


        function setupEventListeners() {
            // Pas besoin d'addEventListener pour logout car on utilise onclick dans le HTML
            
            // Boutons de sauvegarde
            document.getElementById('saveGeneralBtn').addEventListener('click', saveGeneralSettings);
            document.getElementById('saveContactBtn').addEventListener('click', saveContactSettings);
            document.getElementById('savePracticalBtn').addEventListener('click', savePracticalSettings);
            
            
            // Formatage automatique du téléphone
            document.getElementById('cabinet_telephone').addEventListener('input', formatTelephone);
            
            // Autocomplétion adresse et ville
            setupAddressAutocomplete();
            
        }

        // Fonction de formatage du téléphone
        function formatTelephone(e) {
            let value = e.target.value.replace(/\D/g, ''); // Supprimer tout sauf les chiffres
            
            // Si on commence par 33, on garde, sinon on force +33
            if (value.startsWith('33')) {
                value = value.substring(2); // Retirer le 33 initial
            } else if (value.startsWith('0')) {
                value = value.substring(1); // Retirer le 0 initial français
            }
            
            // Limiter à 9 chiffres après +33
            value = value.substring(0, 9);
            
            // Formatter avec espaces
            let formatted = '+33';
            if (value.length > 0) {
                formatted += ' ' + value.charAt(0);
                if (value.length > 1) {
                    formatted += ' ' + value.substring(1, 3);
                    if (value.length > 3) {
                        formatted += ' ' + value.substring(3, 5);
                        if (value.length > 5) {
                            formatted += ' ' + value.substring(5, 7);
                            if (value.length > 7) {
                                formatted += ' ' + value.substring(7, 9);
                            }
                        }
                    }
                }
            }
            
            e.target.value = formatted;
        }

        // Configuration de l'autocomplétion pour les adresses
        function setupAddressAutocomplete() {
            let debounceTimer;
            let selectedCoordinates = null;
            
            // Autocomplétion pour les villes
            const villeInput = document.getElementById('cabinet_ville');
            const villeSuggestions = document.getElementById('ville-suggestions');
            
            villeInput.addEventListener('input', function(e) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = e.target.value.trim();
                    if (query.length < 2) {
                        villeSuggestions.style.display = 'none';
                        return;
                    }
                    searchCities(query, villeSuggestions, villeInput);
                }, 300);
            });

            // Autocomplétion pour les adresses
            const adresseInput = document.getElementById('cabinet_adresse');
            const adresseSuggestions = document.getElementById('adresse-suggestions');
            
            adresseInput.addEventListener('input', function(e) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = e.target.value.trim();
                    if (query.length < 5) {
                        adresseSuggestions.style.display = 'none';
                        document.getElementById('coords-display').textContent = '';
                        return;
                    }
                    searchAddresses(query, adresseSuggestions, adresseInput);
                }, 300);
            });

            // Fermer les suggestions en cliquant ailleurs
            document.addEventListener('click', function(e) {
                if (!villeInput.contains(e.target) && !villeSuggestions.contains(e.target)) {
                    villeSuggestions.style.display = 'none';
                }
                if (!adresseInput.contains(e.target) && !adresseSuggestions.contains(e.target)) {
                    adresseSuggestions.style.display = 'none';
                }
            });
        }

        // Recherche de villes via l'API Adresse française
        async function searchCities(query, suggestionsElement, inputElement) {
            try {
                suggestionsElement.innerHTML = '<div class="suggestion-loading">Recherche en cours...</div>';
                suggestionsElement.style.display = 'block';

                const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&type=municipality&limit=8`);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    suggestionsElement.innerHTML = data.features.map(feature => {
                        const properties = feature.properties;
                        const cityName = properties.city || properties.name;
                        const postcode = properties.postcode;
                        const context = properties.context;
                        
                        return `
                            <div class="suggestion-item" onclick="selectCity('${cityName}', '${postcode}', '${inputElement.id}')">
                                <div class="suggestion-main">${cityName}</div>
                                <div class="suggestion-details">${postcode} - ${context}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    suggestionsElement.innerHTML = '<div class="suggestion-loading">Aucune ville trouvée</div>';
                }
            } catch (error) {
                console.error('Erreur recherche villes:', error);
                suggestionsElement.innerHTML = '<div class="suggestion-loading">Erreur de recherche</div>';
            }
        }

        // Recherche d'adresses complètes
        async function searchAddresses(query, suggestionsElement, inputElement) {
            try {
                suggestionsElement.innerHTML = '<div class="suggestion-loading">Recherche en cours...</div>';
                suggestionsElement.style.display = 'block';

                const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=6`);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    suggestionsElement.innerHTML = data.features.map(feature => {
                        const properties = feature.properties;
                        const coordinates = feature.geometry.coordinates; // [lon, lat]
                        const label = properties.label;
                        const score = Math.round(properties.score * 100);
                        
                        return `
                            <div class="suggestion-item" onclick="selectAddress('${label.replace(/'/g, "\\'")}', ${coordinates[1]}, ${coordinates[0]}, '${inputElement.id}')">
                                <div class="suggestion-main">${label}</div>
                                <div class="suggestion-details">Pertinence: ${score}% - Lat: ${coordinates[1].toFixed(4)}, Lon: ${coordinates[0].toFixed(4)}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    suggestionsElement.innerHTML = '<div class="suggestion-loading">Aucune adresse trouvée</div>';
                }
            } catch (error) {
                console.error('Erreur recherche adresses:', error);
                suggestionsElement.innerHTML = '<div class="suggestion-loading">Erreur de recherche</div>';
            }
        }

        // Sélection d'une ville
        function selectCity(cityName, postcode, inputId) {
            document.getElementById(inputId).value = cityName;
            document.getElementById('ville-suggestions').style.display = 'none';
        }

        // Sélection d'une adresse
        function selectAddress(address, latitude, longitude, inputId) {
            document.getElementById(inputId).value = address;
            document.getElementById('adresse-suggestions').style.display = 'none';
            
            // Afficher les coordonnées
            document.getElementById('coords-display').textContent = ` (📍 ${latitude.toFixed(4)}, ${longitude.toFixed(4)})`;
            
            // Stocker les coordonnées pour un éventuel usage futur (Google Maps, etc.)
            window.selectedCabinetCoordinates = { latitude, longitude, address };
            
            console.log('Coordonnées sélectionnées:', window.selectedCabinetCoordinates);
        }

        // Chargement des paramètres
        async function loadAllSettings() {
            try {
                const response = await fetch('/api/admin/cabinet-settings');
                const data = await response.json();

                if (response.ok) {
                    currentSettings = data.settings || {};
                    populateSettings();
                } else {
                    showError('Erreur lors du chargement des paramètres');
                }
            } catch (error) {
                console.error('Erreur chargement paramètres:', error);
                showError('Erreur de connexion');
            }
        }

        function populateSettings() {
            // Fonction helper pour remplir les champs seulement si ils ont une valeur
            function setFieldValue(id, value) {
                const field = document.getElementById(id);
                if (value && value.trim() !== '') {
                    // Convertir les \n littéraux en vrais sauts de ligne pour les textareas
                    if (field.tagName.toLowerCase() === 'textarea') {
                        field.value = value.replace(/\\n/g, '\n');
                    } else {
                        field.value = value;
                    }
                } else {
                    field.value = '';
                }
            }

            // Informations générales
            setFieldValue('cabinet_nom_docteur', currentSettings.cabinet_nom_docteur);
            setFieldValue('cabinet_specialite', currentSettings.cabinet_specialite);
            setFieldValue('cabinet_ville', currentSettings.cabinet_ville);
            setFieldValue('assistant_nom', currentSettings.assistant_nom);

            // Contact
            setFieldValue('cabinet_telephone', currentSettings.cabinet_telephone);
            setFieldValue('cabinet_email', currentSettings.cabinet_email);
            setFieldValue('cabinet_adresse', currentSettings.cabinet_adresse);
            setFieldValue('cabinet_site_web', currentSettings.cabinet_site_web);

            // Informations pratiques
            setFieldValue('cabinet_rdv_mode', currentSettings.cabinet_rdv_mode);
            setFieldValue('cabinet_parking', currentSettings.cabinet_parking);
            setFieldValue('cabinet_acces', currentSettings.cabinet_acces);
            setFieldValue('cabinet_infos_pratiques', currentSettings.cabinet_infos_pratiques);
        }

        // Fonctions horaires supprimées - gérées sur page dédiée

        // Sauvegarde des paramètres
        async function saveGeneralSettings() {
            console.log('saveGeneralSettings appelée');
            
            const settings = {
                cabinet_nom_docteur: document.getElementById('cabinet_nom_docteur').value,
                cabinet_specialite: document.getElementById('cabinet_specialite').value,
                cabinet_ville: document.getElementById('cabinet_ville').value,
                assistant_nom: document.getElementById('assistant_nom').value
            };

            console.log('Settings à sauvegarder:', settings);
            await saveSettings(settings);
        }

        async function saveContactSettings() {
            const settings = {
                cabinet_telephone: document.getElementById('cabinet_telephone').value,
                cabinet_email: document.getElementById('cabinet_email').value,
                cabinet_adresse: document.getElementById('cabinet_adresse').value,
                cabinet_site_web: document.getElementById('cabinet_site_web').value
            };

            await saveSettings(settings);
        }

        async function savePracticalSettings() {
            const settings = {
                cabinet_rdv_mode: document.getElementById('cabinet_rdv_mode').value,
                cabinet_parking: document.getElementById('cabinet_parking').value,
                cabinet_acces: document.getElementById('cabinet_acces').value,
                cabinet_infos_pratiques: document.getElementById('cabinet_infos_pratiques').value
            };

            await saveSettings(settings);
        }

        // Fonctions saveChatSettings et saveHoraires supprimées - gérées sur pages dédiées

        async function saveSettings(settings) {
            try {
                console.log('saveSettings appelée avec:', settings);
                
                const response = await fetch('/api/admin/cabinet-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ settings })
                });

                console.log('Réponse du serveur:', response.status, response.statusText);
                const result = await response.json();
                console.log('Résultat:', result);

                if (response.ok && result.success) {
                    showSuccess('Paramètres sauvegardés avec succès');
                    // Recharger pour synchroniser
                    loadAllSettings();
                } else {
                    showError(result.error || 'Erreur lors de la sauvegarde');
                }
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showError('Erreur de connexion');
            }
        }


        // Utilitaires
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successAlert').classList.add('active');
            document.getElementById('errorAlert').classList.remove('active');
            
            setTimeout(() => {
                document.getElementById('successAlert').classList.remove('active');
            }, 5000);
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorAlert').classList.add('active');
            document.getElementById('successAlert').classList.remove('active');
            
            setTimeout(() => {
                document.getElementById('errorAlert').classList.remove('active');
            }, 5000);
        }

        // ===== FONCTIONS DE DÉCONNEXION =====
        
        // Fonction de déconnexion
        function logout() {
            document.getElementById('logoutModal').classList.add('active');
        }

        // Fermer modal de déconnexion
        function closeLogoutModal() {
            document.getElementById('logoutModal').classList.remove('active');
        }

        // Confirmer la déconnexion
        async function confirmLogout() {
            try {
                const response = await fetch('/api/admin/logout', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = result.redirect || '/admin/login';
                } else {
                    showError('Erreur lors de la déconnexion');
                    closeLogoutModal();
                }
            } catch (error) {
                console.error('Erreur déconnexion:', error);
                window.location.href = '/admin/login';
            }
        }

        // ===== EVENT LISTENERS DÉCONNEXION =====
        document.addEventListener('DOMContentLoaded', function() {
            // Modal de déconnexion
            document.getElementById('logoutModalClose').addEventListener('click', closeLogoutModal);
            document.getElementById('logoutCancel').addEventListener('click', closeLogoutModal);
            document.getElementById('logoutConfirm').addEventListener('click', confirmLogout);
            
            // Fermer modal logout en cliquant à l'extérieur
            document.getElementById('logoutModal').addEventListener('click', function(e) {
                if (e.target.id === 'logoutModal') {
                    closeLogoutModal();
                }
            });
            
            // Escape pour fermer les modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeLogoutModal();
                }
            });
        });

    </script>

    <!-- Modal de déconnexion -->
    <div class="modal" id="logoutModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="border-bottom: 1px solid #fee2e2; background: #fef2f2;">
                <h3 class="modal-title" style="color: #dc2626; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Déconnexion</span>
                </h3>
                <button class="modal-close" id="logoutModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <div style="text-align: center; padding: var(--spacing-4) 0;">
                    <div style="font-size: 3rem; color: #dc2626; margin-bottom: var(--spacing-4);">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <p style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--spacing-3); color: var(--text-primary);">
                        Êtes-vous sûr de vouloir vous déconnecter ?
                    </p>
                    <p style="color: var(--text-secondary); margin: 0; font-size: var(--font-size-sm);">
                        Vous devrez vous reconnecter pour accéder au tableau de bord.
                    </p>
                </div>
            </div>

            <div class="modal-footer" style="gap: var(--spacing-3);">
                <button class="btn btn-secondary" id="logoutCancel" style="flex: 1;">
                    <i class="fas fa-times"></i>
                    Annuler
                </button>
                <button class="btn btn-danger" id="logoutConfirm" style="flex: 1;">
                    <i class="fas fa-sign-out-alt"></i>
                    Se déconnecter
                </button>
            </div>
        </div>
    </div>
</body>
</html>