<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Paramètres du Cabinet - Administration</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <style>
        /* Styles spécifiques page admin paramètres */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #334155;
            line-height: 1.6;
        }

        /* Import du header unifié */
        @import url('admin-header-template.css');

        /* Import des styles admin communs */
        @import url('admin-common.css');

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Main Layout */
        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Navigation */
        .nav-breadcrumb {
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-breadcrumb a {
            color: #1e40af;
            text-decoration: none;
        }

        .nav-breadcrumb a:hover {
            text-decoration: underline;
        }

        /* Settings Grid */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
        }

        .settings-section {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .section-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1e293b;
        }

        .section-body {
            padding: 1.5rem;
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: border-color 0.2s;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-description {
            font-size: 0.8rem;
            color: #64748b;
            margin-top: 0.25rem;
        }

        /* Styles supprimés - horaires gérés sur page dédiée */


        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 0.75rem;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }

        .modal-close:hover {
            background: #f1f5f9;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 1.5rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Loading */
        .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Suggestions dropdown */
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }

        .suggestion-item {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover {
            background: #f8fafc;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-main {
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .suggestion-details {
            font-size: 0.8rem;
            color: #64748b;
        }

        .suggestion-loading {
            padding: 0.75rem;
            text-align: center;
            color: #64748b;
            font-style: italic;
        }

        /* Success/Error States */
        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: none;
        }

        .alert.success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .alert.error {
            background: #fee2e2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .alert.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .main-container {
                padding: 1rem;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }


            /* Styles horaires supprimés */
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-cogs"></i>
                </div>
                <div>
                    <h1>Paramètres du Cabinet</h1>
                    <p>Configuration générale</p>
                </div>
            </div>
            <div class="user-nav">
                <a href="/admin/emergency" class="btn btn-secondary">
                    <i class="fas fa-phone-alt"></i>
                    Urgences
                </a>
                <a href="/admin/dashboard" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Retour
                </a>
                <button class="btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i>
                    Déconnexion
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="main-container">
        <!-- Navigation Breadcrumb -->
        <div class="nav-breadcrumb">
            <a href="/admin/dashboard">
                <i class="fas fa-home"></i>
                Dashboard
            </a>
            <i class="fas fa-chevron-right"></i>
            <span>Paramètres du Cabinet</span>
        </div>

        <!-- Alerts -->
        <div id="successAlert" class="alert success">
            <i class="fas fa-check-circle"></i>
            <span id="successMessage">Paramètres sauvegardés avec succès</span>
        </div>

        <div id="errorAlert" class="alert error">
            <i class="fas fa-exclamation-circle"></i>
            <span id="errorMessage">Erreur lors de la sauvegarde</span>
        </div>

        <!-- Settings Grid -->
        <div class="settings-grid">
            <!-- Informations Générales -->
            <div class="settings-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-user-md"></i>
                        Informations Générales
                    </h2>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label class="form-label" for="cabinet_nom_docteur">Nom du Médecin</label>
                        <input type="text" id="cabinet_nom_docteur" class="form-input" placeholder="Dr Nom Prénom">
                        <div class="form-description">Nom complet qui apparaîtra sur toutes les pages</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_specialite">Spécialité</label>
                        <input type="text" id="cabinet_specialite" class="form-input" placeholder="Médecin Généraliste">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_ville">Ville</label>
                        <div style="position: relative;">
                            <input type="text" id="cabinet_ville" class="form-input" placeholder="Votre Ville" autocomplete="off">
                            <div id="ville-suggestions" class="suggestions-dropdown" style="display: none;"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="assistant_nom">Nom de l'Assistant IA</label>
                        <input type="text" id="assistant_nom" class="form-input" placeholder="Assistant Médical">
                    </div>

                    <button class="btn btn-primary" id="saveGeneralBtn">
                        <i class="fas fa-save"></i>
                        Sauvegarder
                    </button>
                </div>
            </div>

            <!-- Coordonnées -->
            <div class="settings-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-address-book"></i>
                        Coordonnées
                    </h2>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label class="form-label" for="cabinet_telephone">Téléphone</label>
                        <input type="tel" id="cabinet_telephone" class="form-input" placeholder="+33 X XX XX XX XX" pattern="\+33 [1-9] \d{2} \d{2} \d{2} \d{2}" maxlength="17">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_email">Email (optionnel)</label>
                        <input type="email" id="cabinet_email" class="form-input" placeholder="contact@votre-cabinet.fr">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_adresse">Adresse du cabinet</label>
                        <div style="position: relative;">
                            <textarea id="cabinet_adresse" class="form-textarea" placeholder="Adresse complète du cabinet" autocomplete="off"></textarea>
                            <div id="adresse-suggestions" class="suggestions-dropdown" style="display: none;"></div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_site_web">Site de prise de rendez-vous (optionnel)</label>
                        <input type="url" id="cabinet_site_web" class="form-input" placeholder="https://votre-site-rdv.fr">
                    </div>

                    <button class="btn btn-primary" id="saveContactBtn">
                        <i class="fas fa-save"></i>
                        Sauvegarder
                    </button>
                </div>
            </div>

            <!-- Horaires - Lien vers page dédiée -->
            <div class="settings-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-clock"></i>
                        Horaires d'ouverture
                    </h2>
                    <div class="section-actions">
                        <a href="/admin/schedule" class="btn btn-primary">
                            <i class="fas fa-external-link-alt"></i>
                            Configurer les horaires
                        </a>
                    </div>
                </div>
                <div class="section-body">
                    <div style="text-align: center; padding: 2rem; background: #f8fafc; border-radius: 0.5rem; border: 2px dashed #d1d5db;">
                        <i class="fas fa-clock" style="font-size: 2rem; color: #64748b; margin-bottom: 1rem;"></i>
                        <h3 style="color: #374151; margin-bottom: 0.5rem;">Configuration des horaires d'ouverture</h3>
                        <p style="color: #64748b; margin-bottom: 1.5rem;">
                            Gérez vos horaires d'ouverture avec une interface intuitive et un aperçu en temps réel
                        </p>
                        <a href="/admin/schedule" class="btn btn-primary">
                            <i class="fas fa-arrow-right"></i>
                            Accéder à la gestion des horaires
                        </a>
                    </div>
                </div>
            </div>

            <!-- Informations Pratiques -->
            <div class="settings-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-info-circle"></i>
                        Informations Pratiques
                    </h2>
                </div>
                <div class="section-body">
                    <div class="form-group">
                        <label class="form-label" for="cabinet_rdv_mode">Mode de prise de rendez-vous</label>
                        <input type="text" id="cabinet_rdv_mode" class="form-input" placeholder="Sur rendez-vous uniquement">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_parking">Parking</label>
                        <input type="text" id="cabinet_parking" class="form-input" placeholder="Parking gratuit disponible">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="cabinet_acces">Accessibilité</label>
                        <input type="text" id="cabinet_acces" class="form-input" placeholder="Accessible PMR">
                    </div>

                    <button class="btn btn-primary" id="savePracticalBtn">
                        <i class="fas fa-save"></i>
                        Sauvegarder
                    </button>
                </div>
            </div>

            <!-- Paramètres Chat IA - Lien vers page dédiée -->
            <div class="settings-section">
                <div class="section-header">
                    <h2 class="section-title">
                        <i class="fas fa-robot"></i>
                        Configuration Chat IA
                    </h2>
                    <div class="section-actions">
                        <a href="/admin/chat" class="btn btn-primary">
                            <i class="fas fa-external-link-alt"></i>
                            Configurer le chat IA
                        </a>
                    </div>
                </div>
                <div class="section-body">
                    <div style="text-align: center; padding: 2rem; background: #f8fafc; border-radius: 0.5rem; border: 2px dashed #d1d5db;">
                        <i class="fas fa-robot" style="font-size: 2rem; color: #64748b; margin-bottom: 1rem;"></i>
                        <h3 style="color: #374151; margin-bottom: 0.5rem;">Configuration du Chat IA</h3>
                        <p style="color: #64748b; margin-bottom: 1.5rem;">
                            Configurez les limites, l'assistant virtuel et les paramètres avancés du chat médical
                        </p>
                        <a href="/admin/chat" class="btn btn-primary">
                            <i class="fas fa-arrow-right"></i>
                            Accéder à la configuration du chat
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>


    <script>
        // Variables globales
        let currentSettings = {};

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadAllSettings();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Boutons principaux
            document.getElementById('logoutBtn').addEventListener('click', logout);
            
            // Boutons de sauvegarde
            document.getElementById('saveGeneralBtn').addEventListener('click', saveGeneralSettings);
            document.getElementById('saveContactBtn').addEventListener('click', saveContactSettings);
            document.getElementById('savePracticalBtn').addEventListener('click', savePracticalSettings);
            
            
            // Formatage automatique du téléphone
            document.getElementById('cabinet_telephone').addEventListener('input', formatTelephone);
            
            // Autocomplétion adresse et ville
            setupAddressAutocomplete();
            
        }

        // Fonction de formatage du téléphone
        function formatTelephone(e) {
            let value = e.target.value.replace(/\D/g, ''); // Supprimer tout sauf les chiffres
            
            // Si on commence par 33, on garde, sinon on force +33
            if (value.startsWith('33')) {
                value = value.substring(2); // Retirer le 33 initial
            } else if (value.startsWith('0')) {
                value = value.substring(1); // Retirer le 0 initial français
            }
            
            // Limiter à 9 chiffres après +33
            value = value.substring(0, 9);
            
            // Formatter avec espaces
            let formatted = '+33';
            if (value.length > 0) {
                formatted += ' ' + value.charAt(0);
                if (value.length > 1) {
                    formatted += ' ' + value.substring(1, 3);
                    if (value.length > 3) {
                        formatted += ' ' + value.substring(3, 5);
                        if (value.length > 5) {
                            formatted += ' ' + value.substring(5, 7);
                            if (value.length > 7) {
                                formatted += ' ' + value.substring(7, 9);
                            }
                        }
                    }
                }
            }
            
            e.target.value = formatted;
        }

        // Configuration de l'autocomplétion pour les adresses
        function setupAddressAutocomplete() {
            let debounceTimer;
            let selectedCoordinates = null;
            
            // Autocomplétion pour les villes
            const villeInput = document.getElementById('cabinet_ville');
            const villeSuggestions = document.getElementById('ville-suggestions');
            
            villeInput.addEventListener('input', function(e) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = e.target.value.trim();
                    if (query.length < 2) {
                        villeSuggestions.style.display = 'none';
                        return;
                    }
                    searchCities(query, villeSuggestions, villeInput);
                }, 300);
            });

            // Autocomplétion pour les adresses
            const adresseInput = document.getElementById('cabinet_adresse');
            const adresseSuggestions = document.getElementById('adresse-suggestions');
            
            adresseInput.addEventListener('input', function(e) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    const query = e.target.value.trim();
                    if (query.length < 5) {
                        adresseSuggestions.style.display = 'none';
                        document.getElementById('coords-display').textContent = '';
                        return;
                    }
                    searchAddresses(query, adresseSuggestions, adresseInput);
                }, 300);
            });

            // Fermer les suggestions en cliquant ailleurs
            document.addEventListener('click', function(e) {
                if (!villeInput.contains(e.target) && !villeSuggestions.contains(e.target)) {
                    villeSuggestions.style.display = 'none';
                }
                if (!adresseInput.contains(e.target) && !adresseSuggestions.contains(e.target)) {
                    adresseSuggestions.style.display = 'none';
                }
            });
        }

        // Recherche de villes via l'API Adresse française
        async function searchCities(query, suggestionsElement, inputElement) {
            try {
                suggestionsElement.innerHTML = '<div class="suggestion-loading">Recherche en cours...</div>';
                suggestionsElement.style.display = 'block';

                const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&type=municipality&limit=8`);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    suggestionsElement.innerHTML = data.features.map(feature => {
                        const properties = feature.properties;
                        const cityName = properties.city || properties.name;
                        const postcode = properties.postcode;
                        const context = properties.context;
                        
                        return `
                            <div class="suggestion-item" onclick="selectCity('${cityName}', '${postcode}', '${inputElement.id}')">
                                <div class="suggestion-main">${cityName}</div>
                                <div class="suggestion-details">${postcode} - ${context}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    suggestionsElement.innerHTML = '<div class="suggestion-loading">Aucune ville trouvée</div>';
                }
            } catch (error) {
                console.error('Erreur recherche villes:', error);
                suggestionsElement.innerHTML = '<div class="suggestion-loading">Erreur de recherche</div>';
            }
        }

        // Recherche d'adresses complètes
        async function searchAddresses(query, suggestionsElement, inputElement) {
            try {
                suggestionsElement.innerHTML = '<div class="suggestion-loading">Recherche en cours...</div>';
                suggestionsElement.style.display = 'block';

                const response = await fetch(`https://api-adresse.data.gouv.fr/search/?q=${encodeURIComponent(query)}&limit=6`);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    suggestionsElement.innerHTML = data.features.map(feature => {
                        const properties = feature.properties;
                        const coordinates = feature.geometry.coordinates; // [lon, lat]
                        const label = properties.label;
                        const score = Math.round(properties.score * 100);
                        
                        return `
                            <div class="suggestion-item" onclick="selectAddress('${label.replace(/'/g, "\\'")}', ${coordinates[1]}, ${coordinates[0]}, '${inputElement.id}')">
                                <div class="suggestion-main">${label}</div>
                                <div class="suggestion-details">Pertinence: ${score}% - Lat: ${coordinates[1].toFixed(4)}, Lon: ${coordinates[0].toFixed(4)}</div>
                            </div>
                        `;
                    }).join('');
                } else {
                    suggestionsElement.innerHTML = '<div class="suggestion-loading">Aucune adresse trouvée</div>';
                }
            } catch (error) {
                console.error('Erreur recherche adresses:', error);
                suggestionsElement.innerHTML = '<div class="suggestion-loading">Erreur de recherche</div>';
            }
        }

        // Sélection d'une ville
        function selectCity(cityName, postcode, inputId) {
            document.getElementById(inputId).value = cityName;
            document.getElementById('ville-suggestions').style.display = 'none';
        }

        // Sélection d'une adresse
        function selectAddress(address, latitude, longitude, inputId) {
            document.getElementById(inputId).value = address;
            document.getElementById('adresse-suggestions').style.display = 'none';
            
            // Afficher les coordonnées
            document.getElementById('coords-display').textContent = ` (📍 ${latitude.toFixed(4)}, ${longitude.toFixed(4)})`;
            
            // Stocker les coordonnées pour un éventuel usage futur (Google Maps, etc.)
            window.selectedCabinetCoordinates = { latitude, longitude, address };
            
            console.log('Coordonnées sélectionnées:', window.selectedCabinetCoordinates);
        }

        // Chargement des paramètres
        async function loadAllSettings() {
            try {
                const response = await fetch('/api/admin/cabinet-settings');
                const data = await response.json();

                if (response.ok) {
                    currentSettings = data.settings || {};
                    populateSettings();
                } else {
                    showError('Erreur lors du chargement des paramètres');
                }
            } catch (error) {
                console.error('Erreur chargement paramètres:', error);
                showError('Erreur de connexion');
            }
        }

        function populateSettings() {
            // Fonction helper pour remplir les champs seulement si ils ont une valeur
            function setFieldValue(id, value) {
                const field = document.getElementById(id);
                if (value && value.trim() !== '') {
                    // Convertir les \n littéraux en vrais sauts de ligne pour les textareas
                    if (field.tagName.toLowerCase() === 'textarea') {
                        field.value = value.replace(/\\n/g, '\n');
                    } else {
                        field.value = value;
                    }
                } else {
                    field.value = '';
                }
            }

            // Informations générales
            setFieldValue('cabinet_nom_docteur', currentSettings.cabinet_nom_docteur);
            setFieldValue('cabinet_specialite', currentSettings.cabinet_specialite);
            setFieldValue('cabinet_ville', currentSettings.cabinet_ville);
            setFieldValue('assistant_nom', currentSettings.assistant_nom);

            // Contact
            setFieldValue('cabinet_telephone', currentSettings.cabinet_telephone);
            setFieldValue('cabinet_email', currentSettings.cabinet_email);
            setFieldValue('cabinet_adresse', currentSettings.cabinet_adresse);
            setFieldValue('cabinet_site_web', currentSettings.cabinet_site_web);

            // Informations pratiques
            setFieldValue('cabinet_rdv_mode', currentSettings.cabinet_rdv_mode);
            setFieldValue('cabinet_parking', currentSettings.cabinet_parking);
            setFieldValue('cabinet_acces', currentSettings.cabinet_acces);
        }

        // Fonctions horaires supprimées - gérées sur page dédiée

        // Sauvegarde des paramètres
        async function saveGeneralSettings() {
            console.log('saveGeneralSettings appelée');
            
            const settings = {
                cabinet_nom_docteur: document.getElementById('cabinet_nom_docteur').value,
                cabinet_specialite: document.getElementById('cabinet_specialite').value,
                cabinet_ville: document.getElementById('cabinet_ville').value,
                assistant_nom: document.getElementById('assistant_nom').value
            };

            console.log('Settings à sauvegarder:', settings);
            await saveSettings(settings);
        }

        async function saveContactSettings() {
            const settings = {
                cabinet_telephone: document.getElementById('cabinet_telephone').value,
                cabinet_email: document.getElementById('cabinet_email').value,
                cabinet_adresse: document.getElementById('cabinet_adresse').value,
                cabinet_site_web: document.getElementById('cabinet_site_web').value
            };

            await saveSettings(settings);
        }

        async function savePracticalSettings() {
            const settings = {
                cabinet_rdv_mode: document.getElementById('cabinet_rdv_mode').value,
                cabinet_parking: document.getElementById('cabinet_parking').value,
                cabinet_acces: document.getElementById('cabinet_acces').value
            };

            await saveSettings(settings);
        }

        // Fonctions saveChatSettings et saveHoraires supprimées - gérées sur pages dédiées

        async function saveSettings(settings) {
            try {
                console.log('saveSettings appelée avec:', settings);
                
                const response = await fetch('/api/admin/cabinet-settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ settings })
                });

                console.log('Réponse du serveur:', response.status, response.statusText);
                const result = await response.json();
                console.log('Résultat:', result);

                if (response.ok && result.success) {
                    showSuccess('Paramètres sauvegardés avec succès');
                    // Recharger pour synchroniser
                    loadAllSettings();
                } else {
                    showError(result.error || 'Erreur lors de la sauvegarde');
                }
            } catch (error) {
                console.error('Erreur sauvegarde:', error);
                showError('Erreur de connexion');
            }
        }


        // Utilitaires
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successAlert').classList.add('active');
            document.getElementById('errorAlert').classList.remove('active');
            
            setTimeout(() => {
                document.getElementById('successAlert').classList.remove('active');
            }, 5000);
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorAlert').classList.add('active');
            document.getElementById('successAlert').classList.remove('active');
            
            setTimeout(() => {
                document.getElementById('errorAlert').classList.remove('active');
            }, 5000);
        }

        // Déconnexion
        async function logout() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                try {
                    const response = await fetch('/api/admin/logout', {
                        method: 'POST'
                    });

                    const result = await response.json();

                    if (result.success) {
                        window.location.href = result.redirect || '/admin';
                    } else {
                        alert('Erreur lors de la déconnexion');
                    }
                } catch (error) {
                    console.error('Erreur déconnexion:', error);
                    window.location.href = '/admin';
                }
            }
        }

    </script>
</body>
</html>