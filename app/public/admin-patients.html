<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Gestion Patients - Cabinet Médical</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="stylesheet" href="/styles.css?v=patients-bottom-spacing">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* Réduction drastique de la hauteur des cartes patients */
        .patient-card {
            padding: var(--spacing-2) var(--spacing-3) !important;
            min-height: auto !important;
        }
        
        .patient-header {
            margin-bottom: var(--spacing-2) !important;
            gap: var(--spacing-2) !important;
        }
        
        .patient-info {
            gap: var(--spacing-1) !important;
        }
        
        .patient-name {
            font-size: var(--font-size-base) !important;
            margin-bottom: var(--spacing-1) !important;
            line-height: 1.2 !important;
        }
        
        .patient-details {
            gap: var(--spacing-1) !important;
            font-size: var(--font-size-xs) !important;
        }
        
        .patient-details > div {
            margin-bottom: 0 !important;
            line-height: 1.3 !important;
        }
        
        .patient-actions {
            gap: var(--spacing-2) !important;
            margin-top: var(--spacing-2) !important;
        }
        
        .patient-actions .btn {
            padding: var(--spacing-1) var(--spacing-2) !important;
            font-size: var(--font-size-xs) !important;
        }

        /* Styles pour l'import CSV */
        .csv-upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-8);
            text-align: center;
            background: var(--bg-secondary);
            transition: var(--transition);
            cursor: pointer;
        }

        .csv-upload-zone:hover,
        .csv-upload-zone.dragover {
            border-color: var(--primary-color);
            background: rgba(0, 122, 255, 0.05);
        }

        .upload-content i {
            font-size: 3rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-3);
        }

        .upload-content h4 {
            color: var(--text-primary);
            margin-bottom: var(--spacing-2);
        }

        .upload-content p {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-4);
        }

        .csv-stats {
            display: flex;
            gap: var(--spacing-4);
            padding: var(--spacing-3);
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            margin-top: var(--spacing-3);
        }

        .csv-stat {
            text-align: center;
        }

        .csv-stat-value {
            font-size: var(--font-size-lg);
            font-weight: 600;
            color: var(--primary-color);
        }

        .csv-stat-label {
            font-size: var(--font-size-sm);
            color: var(--text-secondary);
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: var(--spacing-2);
        }

        .progress-bar {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <!-- Header exactement comme dashboard -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <h1 id="adminTitle">Administration</h1>
                        <p id="doctorSpecialty">Gestion des Patients</p>
                    </div>
                </div>
                <nav class="nav">
                    <a href="/admin/dashboard" class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        Dashboard
                    </a>
                    <a href="/admin/patients" class="nav-link active">
                        <i class="fas fa-users"></i>
                        Patients
                    </a>
                    <a href="/admin/schedule" class="nav-link">
                        <i class="fas fa-calendar"></i>
                        Planning
                    </a>
                    <a href="/admin/chat" class="nav-link">
                        <i class="fas fa-robot"></i>
                        Chat IA
                    </a>
                    <a href="/admin/cabinet" class="nav-link">
                        <i class="fas fa-building"></i>
                        Cabinet
                    </a>
                    <a href="/admin/emergency" class="nav-link">
                        <i class="fas fa-phone-alt"></i>
                        Urgences
                    </a>
                    <button class="btn btn-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                        Déconnexion
                    </button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- Section Stats -->
        <section class="section" style="padding-top: var(--spacing-12); padding-bottom: 0;">
            <div class="container">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Total Patients</div>
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalPatients">--</div>
                        <div class="stat-subtitle">Patients enregistrés</div>
                    </div>

                    <div class="stat-card success">
                        <div class="stat-header">
                            <div class="stat-title">Actifs</div>
                            <div class="stat-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="activePatients">--</div>
                        <div class="stat-subtitle">Patients actifs</div>
                    </div>

                    <div class="stat-card urgent">
                        <div class="stat-header">
                            <div class="stat-title">Inactifs</div>
                            <div class="stat-icon">
                                <i class="fas fa-user-times"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="inactivePatients">--</div>
                        <div class="stat-subtitle">Patients inactifs</div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-header">
                            <div class="stat-title">Ce mois</div>
                            <div class="stat-icon">
                                <i class="fas fa-user-plus"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="newThisMonth">--</div>
                        <div class="stat-subtitle">Nouveaux patients</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Section Patients -->
        <section style="padding: 0 0 var(--spacing-16) 0;">
            <div class="container">
                <div class="card">
                    <div class="card-header">
                        <h2 class="section-title">
                            <i class="fas fa-list"></i>
                            Liste des Patients
                        </h2>
                        <div class="card-actions">
                            <button class="btn btn-secondary" id="refreshBtn">
                                <i class="fas fa-sync-alt"></i>
                                Actualiser
                            </button>
                            <button class="btn btn-info" id="importCsvBtn">
                                <i class="fas fa-file-import"></i>
                                Importer CSV
                            </button>
                            <button class="btn btn-primary" id="addPatientBtn">
                                <i class="fas fa-plus"></i>
                                Ajouter un patient
                            </button>
                        </div>
                    </div>

                    <div class="card-body">
                        <!-- Filtres -->
                        <div class="filters-row">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="searchInput" placeholder="Rechercher par nom, prénom, téléphone ou email...">
                            </div>
                            <select id="statusFilter" class="form-select">
                                <option value="all">Tous les statuts</option>
                                <option value="active">Actifs seulement</option>
                                <option value="inactive">Inactifs seulement</option>
                            </select>
                            <select id="sortFilter" class="form-select">
                                <option value="name">Trier par nom</option>
                                <option value="created">Plus récents</option>
                                <option value="age">Par âge</option>
                            </select>
                        </div>

                        <!-- Alertes -->
                        <div id="successAlert" class="alert alert-success" style="display: none;">
                            <i class="fas fa-check-circle"></i>
                            <span id="successMessage">Opération réussie</span>
                        </div>

                        <div id="errorAlert" class="alert alert-danger" style="display: none;">
                            <i class="fas fa-exclamation-circle"></i>
                            <span id="errorMessage">Une erreur est survenue</span>
                        </div>

                        <!-- Liste des patients -->
                        <div id="patientsGrid" class="patients-grid">
                            <!-- Patients will be loaded here -->
                        </div>

                        <!-- Pagination -->
                        <div class="pagination" id="pagination" style="display: none;">
                            <!-- Pagination buttons will be generated here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal Patient -->
    <div class="modal" id="patientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="patientModalTitle">Ajouter un patient</h3>
                <button class="modal-close" id="patientModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <form id="patientForm">
                    <input type="hidden" id="patientId">
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label" for="patientNom">Nom *</label>
                            <input type="text" id="patientNom" class="form-control" required maxlength="100" placeholder="MARTIN">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="patientPrenom">Prénom *</label>
                            <input type="text" id="patientPrenom" class="form-control" required maxlength="100" placeholder="Sophie">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="patientDateNaissance">Date de naissance *</label>
                        <input type="date" id="patientDateNaissance" class="form-control" required>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label class="form-label" for="patientTelephone">Téléphone</label>
                            <input type="tel" id="patientTelephone" class="form-control" maxlength="20" placeholder="+33 6 12 34 56 78">
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="patientEmail">Email</label>
                            <input type="email" id="patientEmail" class="form-control" maxlength="255" placeholder="sophie.martin@email.com">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="patientActif">Statut</label>
                        <select id="patientActif" class="form-control">
                            <option value="true">Actif</option>
                            <option value="false">Inactif</option>
                        </select>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" id="patientCancelBtn">
                    Annuler
                </button>
                <button class="btn btn-primary" id="patientSaveBtn">
                    <i class="fas fa-save"></i>
                    Enregistrer
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Import CSV -->
    <div class="modal" id="importCsvModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-file-import"></i>
                    Importer des patients via CSV
                </h3>
                <button class="modal-close" id="importCsvModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <!-- Instructions -->
                <div class="alert alert-info" style="margin-bottom: var(--spacing-4);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: var(--spacing-3);">
                        <div>
                            <h4><i class="fas fa-info-circle"></i> Format CSV attendu</h4>
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" id="downloadSampleBtn">
                            <i class="fas fa-download"></i>
                            Télécharger exemple CSV
                        </button>
                    </div>
                    <p>Le fichier CSV doit contenir les colonnes suivantes (avec header) :</p>
                    <code>nom,prenom,date_naissance,telephone,email</code>
                    <br><br>
                    <strong>Exemple :</strong><br>
                    <code>MARTIN,Sophie,1985-03-15,+33612345678,sophie.martin@email.com</code>
                </div>

                <!-- Zone de drop -->
                <div class="csv-upload-zone" id="csvUploadZone">
                    <div class="upload-content">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h4>Déposez votre fichier CSV ici</h4>
                        <p>ou cliquez pour sélectionner un fichier</p>
                        <input type="file" id="csvFileInput" accept=".csv,.txt" style="display: none;">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('csvFileInput').click();">
                            <i class="fas fa-folder-open"></i>
                            Choisir un fichier
                        </button>
                    </div>
                </div>

                <!-- Preview des données -->
                <div id="csvPreviewSection" style="display: none; margin-top: var(--spacing-4);">
                    <h4><i class="fas fa-eye"></i> Aperçu des données</h4>
                    <div class="table-container" style="max-height: 300px; overflow-y: auto;">
                        <table class="table" id="csvPreviewTable">
                            <thead id="csvPreviewHeader"></thead>
                            <tbody id="csvPreviewBody"></tbody>
                        </table>
                    </div>
                    <div id="csvStats" class="csv-stats"></div>
                </div>

                <!-- Messages d'erreur -->
                <div id="csvErrors" style="display: none; margin-top: var(--spacing-4);">
                    <div class="alert alert-danger">
                        <h4><i class="fas fa-exclamation-triangle"></i> Erreurs détectées</h4>
                        <ul id="csvErrorsList"></ul>
                    </div>
                </div>

                <!-- Progression -->
                <div id="csvProgress" style="display: none; margin-top: var(--spacing-4);">
                    <div class="progress-container">
                        <div class="progress-bar" id="csvProgressBar"></div>
                    </div>
                    <p id="csvProgressText">Traitement en cours...</p>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" id="importCsvCancelBtn">
                    Annuler
                </button>
                <button class="btn btn-primary" id="importCsvSubmitBtn" disabled>
                    <i class="fas fa-upload"></i>
                    Importer les patients
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de déconnexion -->
    <div class="modal" id="logoutModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" style="border-bottom: 1px solid #fee2e2; background: #fef2f2;">
                <h3 class="modal-title" style="color: #dc2626; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Déconnexion</span>
                </h3>
                <button class="modal-close" id="logoutModalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="modal-body">
                <div style="text-align: center; padding: var(--spacing-4) 0;">
                    <div style="font-size: 3rem; color: #dc2626; margin-bottom: var(--spacing-4);">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <p style="font-size: var(--font-size-lg); font-weight: 600; margin-bottom: var(--spacing-3); color: var(--text-primary);">
                        Êtes-vous sûr de vouloir vous déconnecter ?
                    </p>
                    <p style="color: var(--text-secondary); margin: 0; font-size: var(--font-size-sm);">
                        Vous devrez vous reconnecter pour accéder au tableau de bord.
                    </p>
                </div>
            </div>

            <div class="modal-footer" style="gap: var(--spacing-3);">
                <button class="btn btn-secondary" id="logoutCancel" style="flex: 1;">
                    <i class="fas fa-times"></i>
                    Annuler
                </button>
                <button class="btn btn-danger" id="logoutConfirm" style="flex: 1;">
                    <i class="fas fa-sign-out-alt"></i>
                    Se déconnecter
                </button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let currentPatients = [];
        let filteredPatients = [];
        let selectedPatients = new Set();
        let editingPatientId = null;
        let currentPage = 1;
        const patientsPerPage = 10;

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            loadPatients();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Boutons principaux
            document.getElementById('refreshBtn').addEventListener('click', loadPatients);
            document.getElementById('addPatientBtn').addEventListener('click', () => openPatientModal());
            document.getElementById('importCsvBtn').addEventListener('click', () => openImportCsvModal());
            
            // Modal patient
            document.getElementById('patientModalClose').addEventListener('click', closePatientModal);
            document.getElementById('patientCancelBtn').addEventListener('click', closePatientModal);
            document.getElementById('patientSaveBtn').addEventListener('click', savePatient);
            
            // Modal import CSV
            document.getElementById('importCsvModalClose').addEventListener('click', closeImportCsvModal);
            document.getElementById('importCsvCancelBtn').addEventListener('click', closeImportCsvModal);
            document.getElementById('csvFileInput').addEventListener('change', handleCsvFileSelect);
            document.getElementById('importCsvSubmitBtn').addEventListener('click', importCsvData);
            document.getElementById('downloadSampleBtn').addEventListener('click', downloadSampleCsv);
            
            // Drag & Drop
            const csvUploadZone = document.getElementById('csvUploadZone');
            csvUploadZone.addEventListener('click', () => document.getElementById('csvFileInput').click());
            csvUploadZone.addEventListener('dragover', handleDragOver);
            csvUploadZone.addEventListener('dragleave', handleDragLeave);
            csvUploadZone.addEventListener('drop', handleDrop);
            
            // Modal de déconnexion
            document.getElementById('logoutModalClose').addEventListener('click', closeLogoutModal);
            document.getElementById('logoutCancel').addEventListener('click', closeLogoutModal);
            document.getElementById('logoutConfirm').addEventListener('click', confirmLogout);
            
            // Fermer modal logout en cliquant à l'extérieur
            document.getElementById('logoutModal').addEventListener('click', function(e) {
                if (e.target.id === 'logoutModal') {
                    closeLogoutModal();
                }
            });
            
            // Search et filtres
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('sortFilter').addEventListener('change', applyFilters);
            
            // Formatage téléphone
            document.getElementById('patientTelephone').addEventListener('input', formatTelephone);
            
            // Fermer modal en cliquant à l'extérieur
            document.getElementById('patientModal').addEventListener('click', function(e) {
                if (e.target.id === 'patientModal') closePatientModal();
            });
        }


        // Chargement des patients
        async function loadPatients() {
            try {
                const response = await fetch('/api/admin/patients');
                const data = await response.json();

                if (response.ok) {
                    currentPatients = data.patients || [];
                    updateStats();
                    applyFilters();
                } else {
                    showError('Erreur lors du chargement des patients');
                }
            } catch (error) {
                console.error('Erreur chargement patients:', error);
                showError('Erreur de connexion');
            }
        }

        // Mise à jour des statistiques
        function updateStats() {
            const totalPatients = currentPatients.length;
            const activePatients = currentPatients.filter(p => p.actif).length;
            const inactivePatients = totalPatients - activePatients;
            
            // Nouveaux ce mois (simulation)
            const now = new Date();
            const thisMonth = currentPatients.filter(p => {
                const created = new Date(p.created_at);
                return created.getMonth() === now.getMonth() && created.getFullYear() === now.getFullYear();
            }).length;

            document.getElementById('totalPatients').textContent = totalPatients;
            document.getElementById('activePatients').textContent = activePatients;
            document.getElementById('inactivePatients').textContent = inactivePatients;
            document.getElementById('newThisMonth').textContent = thisMonth;
        }

        // Application des filtres
        function applyFilters() {
            let filtered = [...currentPatients];
            
            // Recherche
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(patient => 
                    patient.nom.toLowerCase().includes(searchTerm) ||
                    patient.prenom.toLowerCase().includes(searchTerm) ||
                    (patient.telephone && patient.telephone.toLowerCase().includes(searchTerm)) ||
                    (patient.email && patient.email.toLowerCase().includes(searchTerm))
                );
            }
            
            // Filtre statut
            const statusFilter = document.getElementById('statusFilter').value;
            if (statusFilter === 'active') {
                filtered = filtered.filter(p => p.actif);
            } else if (statusFilter === 'inactive') {
                filtered = filtered.filter(p => !p.actif);
            }
            
            // Tri
            const sortFilter = document.getElementById('sortFilter').value;
            filtered.sort((a, b) => {
                switch (sortFilter) {
                    case 'name':
                        return `${a.nom} ${a.prenom}`.localeCompare(`${b.nom} ${b.prenom}`);
                    case 'created':
                        return new Date(b.created_at) - new Date(a.created_at);
                    case 'age':
                        return new Date(a.date_naissance) - new Date(b.date_naissance);
                    default:
                        return 0;
                }
            });
            
            filteredPatients = filtered;
            currentPage = 1;
            displayPatients();
        }

        // Affichage des patients
        function displayPatients() {
            const container = document.getElementById('patientsGrid');
            const startIndex = (currentPage - 1) * patientsPerPage;
            const endIndex = startIndex + patientsPerPage;
            const patientsToShow = filteredPatients.slice(startIndex, endIndex);

            if (patientsToShow.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>Aucun patient trouvé</h3>
                        <p>Aucun patient ne correspond aux critères de recherche.</p>
                    </div>
                `;
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            container.innerHTML = patientsToShow.map(patient => {
                const age = calculateAge(patient.date_naissance);
                return `
                    <div class="patient-card" data-patient-id="${patient.id}">
                        <div class="patient-header">
                            <div class="patient-info">
                                <div class="patient-name">${escapeHtml(patient.prenom)} ${escapeHtml(patient.nom)}</div>
                                <div class="patient-details">
                                    <div><i class="fas fa-birthday-cake"></i> ${age} ans (${formatDate(patient.date_naissance)})</div>
                                    ${patient.telephone ? `<div><i class="fas fa-phone"></i> ${escapeHtml(patient.telephone)}</div>` : ''}
                                    ${patient.email ? `<div><i class="fas fa-envelope"></i> ${escapeHtml(patient.email)}</div>` : ''}
                                </div>
                            </div>
                            <div class="patient-meta">
                                <span class="badge ${patient.actif ? 'badge-success' : 'badge-danger'}">
                                    ${patient.actif ? 'Actif' : 'Inactif'}
                                </span>
                            </div>
                        </div>
                        <div class="patient-actions">
                            <button class="btn btn-secondary btn-sm" onclick="editPatient(${patient.id})" title="Modifier">
                                <i class="fas fa-edit"></i>
                                Modifier
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deletePatient(${patient.id})" title="Supprimer">
                                <i class="fas fa-trash"></i>
                                Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            updatePagination();
        }

        // Calcul de l'âge
        function calculateAge(dateNaissance) {
            const today = new Date();
            const birthDate = new Date(dateNaissance);
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        // Formatage de date
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR');
        }

        // Mise à jour de la pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);
            const paginationContainer = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                paginationContainer.style.display = 'none';
                return;
            }
            
            paginationContainer.style.display = 'flex';
            
            let paginationHTML = '';
            
            // Bouton précédent
            paginationHTML += `
                <button class="btn btn-secondary" ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </button>
            `;
            
            // Pages
            for (let i = Math.max(1, currentPage - 2); i <= Math.min(totalPages, currentPage + 2); i++) {
                paginationHTML += `
                    <button class="btn ${i === currentPage ? 'btn-primary' : 'btn-secondary'}" onclick="changePage(${i})">
                        ${i}
                    </button>
                `;
            }
            
            // Bouton suivant
            paginationHTML += `
                <button class="btn btn-secondary" ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </button>
            `;
            
            paginationContainer.innerHTML = paginationHTML;
        }

        // Changement de page
        function changePage(page) {
            const totalPages = Math.ceil(filteredPatients.length / patientsPerPage);
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                displayPatients();
            }
        }

        // Modal patient
        function openPatientModal(patient = null) {
            editingPatientId = patient ? patient.id : null;
            
            document.getElementById('patientModalTitle').textContent = 
                patient ? 'Modifier le patient' : 'Ajouter un patient';
            
            if (patient) {
                document.getElementById('patientId').value = patient.id;
                document.getElementById('patientNom').value = patient.nom;
                document.getElementById('patientPrenom').value = patient.prenom;
                document.getElementById('patientDateNaissance').value = patient.date_naissance ? patient.date_naissance.split('T')[0] : '';
                document.getElementById('patientTelephone').value = patient.telephone || '';
                document.getElementById('patientEmail').value = patient.email || '';
                document.getElementById('patientActif').value = patient.actif.toString();
            } else {
                document.getElementById('patientForm').reset();
                document.getElementById('patientId').value = '';
                document.getElementById('patientActif').value = 'true';
            }
            
            document.getElementById('patientModal').classList.add('active');
        }

        function closePatientModal() {
            document.getElementById('patientModal').classList.remove('active');
            editingPatientId = null;
        }

        function editPatient(patientId) {
            const patient = currentPatients.find(p => p.id === patientId);
            if (patient) {
                openPatientModal(patient);
            }
        }

        // Sauvegarde patient
        async function savePatient() {
            try {
                const formData = {
                    nom: document.getElementById('patientNom').value.trim().toUpperCase(),
                    prenom: document.getElementById('patientPrenom').value.trim(),
                    date_naissance: document.getElementById('patientDateNaissance').value,
                    telephone: document.getElementById('patientTelephone').value.trim(),
                    email: document.getElementById('patientEmail').value.trim(),
                    actif: document.getElementById('patientActif').value === 'true'
                };

                if (!formData.nom || !formData.prenom || !formData.date_naissance) {
                    showError('Nom, prénom et date de naissance sont obligatoires');
                    return;
                }

                const url = editingPatientId ? 
                    `/api/admin/patients/${editingPatientId}` : 
                    '/api/admin/patients';
                const method = editingPatientId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    closePatientModal();
                    showSuccess(result.message || 'Patient sauvegardé');
                    loadPatients();
                } else {
                    showError(result.error || 'Erreur lors de la sauvegarde');
                }
            } catch (error) {
                console.error('Erreur sauvegarde patient:', error);
                showError('Erreur de connexion');
            }
        }

        // Suppression patient
        async function deletePatient(patientId) {
            const patient = currentPatients.find(p => p.id === patientId);
            if (!patient) return;
            
            if (!confirm(`Êtes-vous sûr de vouloir supprimer le patient ${patient.prenom} ${patient.nom} ?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/patients/${patientId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showSuccess('Patient supprimé');
                    loadPatients();
                } else {
                    showError(result.error || 'Erreur lors de la suppression');
                }
            } catch (error) {
                console.error('Erreur suppression patient:', error);
                showError('Erreur de connexion');
            }
        }

        // ===== FONCTIONS IMPORT CSV =====
        
        let csvData = [];
        let validCsvData = [];

        function openImportCsvModal() {
            document.getElementById('importCsvModal').classList.add('active');
            resetCsvModal();
        }

        function closeImportCsvModal() {
            document.getElementById('importCsvModal').classList.remove('active');
            resetCsvModal();
        }

        function resetCsvModal() {
            csvData = [];
            validCsvData = [];
            document.getElementById('csvFileInput').value = '';
            document.getElementById('csvPreviewSection').style.display = 'none';
            document.getElementById('csvErrors').style.display = 'none';
            document.getElementById('csvProgress').style.display = 'none';
            document.getElementById('importCsvSubmitBtn').disabled = true;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processCsvFile(files[0]);
            }
        }

        function handleCsvFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) {
                processCsvFile(files[0]);
            }
        }

        async function processCsvFile(file) {
            if (!file.name.toLowerCase().endsWith('.csv') && !file.name.toLowerCase().endsWith('.txt')) {
                showError('Veuillez sélectionner un fichier CSV (.csv ou .txt)');
                return;
            }

            try {
                const text = await file.text();
                const lines = text.split('\n').filter(line => line.trim());
                
                if (lines.length < 2) {
                    showError('Le fichier CSV doit contenir au moins une ligne de header et une ligne de données');
                    return;
                }

                // Parse CSV
                csvData = lines.map(line => {
                    // Simple CSV parser - handles basic cases
                    return line.split(',').map(cell => cell.trim().replace(/^["']|["']$/g, ''));
                });

                const headers = csvData[0];
                const dataRows = csvData.slice(1);

                // Validation des headers
                const requiredHeaders = ['nom', 'prenom', 'date_naissance'];
                const headerMap = {};
                
                headers.forEach((header, index) => {
                    headerMap[header.toLowerCase()] = index;
                });

                const missingHeaders = requiredHeaders.filter(header => 
                    !headerMap.hasOwnProperty(header)
                );

                if (missingHeaders.length > 0) {
                    showError(`Headers manquants: ${missingHeaders.join(', ')}`);
                    return;
                }

                // Validation des données
                const errors = [];
                validCsvData = [];

                dataRows.forEach((row, index) => {
                    const rowNumber = index + 2; // +2 car ligne 1 = header
                    const patient = {};
                    let rowErrors = [];

                    // Nom (requis)
                    patient.nom = row[headerMap.nom] || '';
                    if (!patient.nom) {
                        rowErrors.push('Nom manquant');
                    }

                    // Prénom (requis)
                    patient.prenom = row[headerMap.prenom] || '';
                    if (!patient.prenom) {
                        rowErrors.push('Prénom manquant');
                    }

                    // Date de naissance (requis)
                    patient.date_naissance = row[headerMap.date_naissance] || '';
                    if (!patient.date_naissance) {
                        rowErrors.push('Date de naissance manquante');
                    } else if (!isValidDate(patient.date_naissance)) {
                        rowErrors.push('Date de naissance invalide (format: YYYY-MM-DD)');
                    }

                    // Téléphone (optionnel)
                    patient.telephone = row[headerMap.telephone] || '';

                    // Email (optionnel)
                    patient.email = row[headerMap.email] || '';
                    if (patient.email && !isValidEmail(patient.email)) {
                        rowErrors.push('Email invalide');
                    }

                    if (rowErrors.length > 0) {
                        errors.push(`Ligne ${rowNumber}: ${rowErrors.join(', ')}`);
                    } else {
                        validCsvData.push(patient);
                    }
                });

                // Affichage des résultats
                displayCsvPreview(headers, dataRows, errors);

            } catch (error) {
                console.error('Erreur processing CSV:', error);
                showError('Erreur lors de la lecture du fichier');
            }
        }

        function displayCsvPreview(headers, dataRows, errors) {
            // Afficher erreurs si il y en a
            if (errors.length > 0) {
                document.getElementById('csvErrors').style.display = 'block';
                document.getElementById('csvErrorsList').innerHTML = 
                    errors.map(error => `<li>${error}</li>`).join('');
            } else {
                document.getElementById('csvErrors').style.display = 'none';
            }

            // Preview des données
            document.getElementById('csvPreviewSection').style.display = 'block';
            
            const headerHtml = headers.map(header => `<th>${escapeHtml(header)}</th>`).join('');
            document.getElementById('csvPreviewHeader').innerHTML = `<tr>${headerHtml}</tr>`;
            
            const bodyHtml = dataRows.slice(0, 5).map(row => // Show first 5 rows only
                `<tr>${row.map(cell => `<td>${escapeHtml(cell)}</td>`).join('')}</tr>`
            ).join('');
            document.getElementById('csvPreviewBody').innerHTML = bodyHtml;

            // Statistiques
            const stats = `
                <div class="csv-stat">
                    <div class="csv-stat-value">${dataRows.length}</div>
                    <div class="csv-stat-label">Lignes totales</div>
                </div>
                <div class="csv-stat">
                    <div class="csv-stat-value">${validCsvData.length}</div>
                    <div class="csv-stat-label">Patients valides</div>
                </div>
                <div class="csv-stat">
                    <div class="csv-stat-value">${errors.length}</div>
                    <div class="csv-stat-label">Erreurs</div>
                </div>
            `;
            document.getElementById('csvStats').innerHTML = stats;

            // Activer le bouton d'import si il y a des données valides
            document.getElementById('importCsvSubmitBtn').disabled = validCsvData.length === 0;
        }

        async function importCsvData() {
            if (validCsvData.length === 0) {
                showError('Aucune donnée valide à importer');
                return;
            }

            document.getElementById('csvProgress').style.display = 'block';
            document.getElementById('importCsvSubmitBtn').disabled = true;

            try {
                let imported = 0;
                let failed = 0;

                for (let i = 0; i < validCsvData.length; i++) {
                    const patient = validCsvData[i];
                    
                    // Update progress
                    const progress = ((i + 1) / validCsvData.length) * 100;
                    document.getElementById('csvProgressBar').style.width = `${progress}%`;
                    document.getElementById('csvProgressText').textContent = 
                        `Import en cours... ${i + 1}/${validCsvData.length}`;

                    try {
                        const response = await fetch('/api/admin/patients', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                nom: patient.nom.toUpperCase(),
                                prenom: patient.prenom,
                                date_naissance: patient.date_naissance,
                                telephone: patient.telephone,
                                email: patient.email,
                                actif: true
                            })
                        });

                        const result = await response.json();
                        
                        if (response.ok && result.success) {
                            imported++;
                        } else {
                            failed++;
                            console.warn(`Échec import ${patient.nom} ${patient.prenom}:`, result.error);
                        }
                    } catch (error) {
                        failed++;
                        console.error(`Erreur import ${patient.nom} ${patient.prenom}:`, error);
                    }

                    // Small delay to prevent overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // Résultats finaux
                showSuccess(`Import terminé: ${imported} patients importés, ${failed} échecs`);
                closeImportCsvModal();
                loadPatients(); // Reload the patient list

            } catch (error) {
                console.error('Erreur générale import:', error);
                showError('Erreur lors de l\'import');
            } finally {
                document.getElementById('csvProgress').style.display = 'none';
                document.getElementById('importCsvSubmitBtn').disabled = false;
            }
        }

        function isValidDate(dateString) {
            const regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!regex.test(dateString)) return false;
            
            const date = new Date(dateString);
            return date instanceof Date && !isNaN(date);
        }

        function isValidEmail(email) {
            const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return regex.test(email);
        }

        function downloadSampleCsv() {
            // Créer un CSV d'exemple avec plusieurs patients fictifs
            const sampleData = [
                ['nom', 'prenom', 'date_naissance', 'telephone', 'email'],
                ['MARTIN', 'Sophie', '1985-03-15', '+33612345678', 'sophie.martin@email.com'],
                ['DUBOIS', 'Pierre', '1978-11-22', '0123456789', 'pierre.dubois@gmail.com'],
                ['BERNARD', 'Marie', '1992-07-08', '+33687654321', 'marie.bernard@outlook.fr'],
                ['PETIT', 'Paul', '1965-12-03', '0145678901', 'paul.petit@yahoo.fr'],
                ['MOREAU', 'Claire', '1990-04-25', '', 'claire.moreau@hotmail.com']
            ];

            // Convertir en CSV
            const csvContent = sampleData.map(row => 
                row.map(field => {
                    // Échapper les guillemets et encapsuler les champs si nécessaire
                    if (field.includes(',') || field.includes('"') || field.includes('\n')) {
                        return '"' + field.replace(/"/g, '""') + '"';
                    }
                    return field;
                }).join(',')
            ).join('\n');

            // Créer le blob et télécharger
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'exemple-patients.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showSuccess('Fichier exemple téléchargé : exemple-patients.csv');
            } else {
                showError('Téléchargement non supporté par ce navigateur');
            }
        }

        // Formatage téléphone
        function formatTelephone(e) {
            let value = e.target.value.replace(/\D/g, '');
            
            if (value.startsWith('33')) {
                value = value.substring(2);
            } else if (value.startsWith('0')) {
                value = value.substring(1);
            }
            
            value = value.substring(0, 9);
            
            let formatted = '+33';
            if (value.length > 0) {
                formatted += ' ' + value.charAt(0);
                if (value.length > 1) {
                    formatted += ' ' + value.substring(1, 3);
                    if (value.length > 3) {
                        formatted += ' ' + value.substring(3, 5);
                        if (value.length > 5) {
                            formatted += ' ' + value.substring(5, 7);
                            if (value.length > 7) {
                                formatted += ' ' + value.substring(7, 9);
                            }
                        }
                    }
                }
            }
            
            e.target.value = formatted;
        }

        // Utilitaires
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successAlert').style.display = 'flex';
            document.getElementById('errorAlert').style.display = 'none';
            
            setTimeout(() => {
                document.getElementById('successAlert').style.display = 'none';
            }, 5000);
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorAlert').style.display = 'flex';
            document.getElementById('successAlert').style.display = 'none';
            
            setTimeout(() => {
                document.getElementById('errorAlert').style.display = 'none';
            }, 5000);
        }

        // ===== FONCTIONS DE DÉCONNEXION =====
        
        // Fonction de déconnexion
        function logout() {
            document.getElementById('logoutModal').classList.add('active');
        }

        // Fermer modal de déconnexion
        function closeLogoutModal() {
            document.getElementById('logoutModal').classList.remove('active');
        }

        // Confirmer la déconnexion
        async function confirmLogout() {
            try {
                const response = await fetch('/api/admin/logout', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    window.location.href = result.redirect || '/admin/login';
                } else {
                    showError('Erreur lors de la déconnexion');
                    closeLogoutModal();
                }
            } catch (error) {
                console.error('Erreur déconnexion:', error);
                window.location.href = '/admin/login';
            }
        }

        // Raccourcis clavier
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closePatientModal();
                closeImportCsvModal();
                closeLogoutModal();
            }
            
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                openPatientModal();
            }
        });
    </script>
</body>
</html>